---
date: '2022-12-29'
title: 'Automatizando deploy de login na Auth0 com Azure Pipelines'
description: 'Utilizando pipelines para automatizar o deploy do login customizado na Auth0'
tags: ['Auth0', 'CI/CD', 'Azure DevOps']
---

## Introdu√ß√£o

No painel da Auth0 √© poss√≠vel adicionar um c√≥digo HTML para sobrescrever o Universal Login (solu√ß√£o de login pronta da Auth0) mas nada al√©m disso. Outros arquivos est√°ticos como JS, CSS e imagens precisam ser hospedados em algum servi√ßo de armazenamento como Blob Storage da Azure ou o S3 da AWS.

## Next.js e configura√ß√µes

Para essa solu√ß√£o vou utilizar o framework Next.js para construir a p√°gina usando React e lidar com a gera√ß√£o dos arquivos est√°ticos. O foco aqui √© o processo de deploy ent√£o vou manter o padr√£o do `create-next-app`.

No Next.js tem a op√ß√£o para gerar apenas arquivos est√°ticos, usando o comando: `next export`. Vamos mudar o script de build para contemplar tamb√©m o `export`:

```json
"scripts": {
  "build": "next build && next export"
}
```

Por padr√£o, ao exportar os est√°ticos, a refer√™ncia dentro do HTML √© para o path local. Para configurar uma CDN podemos utilizar a [configura√ß√£o de `assetPrefix`](https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix) no arquivo `next.config.ts`:

```tsx showLineNumbers title="next.config.ts"
const isProd = process.env.NODE_ENV === 'production'

module.exports = {
  // Use the CDN in production and localhost for development.
  assetPrefix: isProd ? 'https://cdn.mydomain.com' : undefined,
}
```

## Conta no Azure DevOps

Entre ou fa√ßa o cadastro no Azure DevOps, crie uma nova organiza√ß√£o e um novo projeto seguindo as instru√ß√µes normalmente.

A Azure oferece gratuitamente um plano limitado, que inclui pipelines, para voc√™ testar e aprender mais sobre a plataforma. Por√©m, ao criar minha conta as pipelines estavam bloqueadas. Foi necess√°rio solicitar o acesso em um formul√°rio, veja detalhes [nesse release note](https://learn.microsoft.com/en-us/azure/devops/release-notes/2021/sprint-184-update#changes-to-azure-pipelines-free-grants).

## Criar uma pipeline

Com uma conta no Azure DevOps e a permiss√£o de pipelines podemos criar nossa pipeline:

1. Dentro da se√ß√£o de pipeline, clique em "New pipeline‚Äù.
2. Conecte na sua conta do Github ou outro servi√ßo
3. Selecione o reposit√≥rio do seu projeto
4. Escolha uma configura√ß√£o inicial (nesse caso, Node.js com React)
5. Clique em "Save and run‚Äù

E‚Ä¶ pronto! Temos a nossa primeira vers√£o da pipeline. Ser√° feito um commit do arquivo `azure-pipelines.yml` que dever√° se parecer com isso:

```yaml showLineNumbers title="azure-pipelines.yml"
trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '16.x'
    displayName: 'Install Node.js'

  - script: |
      yarn --frozen-lockfile
      yarn build
    displayName: 'yarn install and build'
```

**Obs:** fiz algumas mudan√ßas para usar o `yarn` no lugar do `npm`.

## Deploy na Auth0

Vamos instalar e configurar a CLI de deploy da Auth0 no projeto com os seguintes passos:

1. Instale o pacote `auth0-deploy-cli`.

   ```bash
   yarn add auth0-deploy-cli
   ```

2. Na raiz do projeto, crie um arquivo com o nome `tenant.yaml` e adicione a configura√ß√£o da p√°gina de login:

   ```yaml showLineNumbers title="tenant.yaml"
   pages:
     - name: login
       enabled: true
       html: ./out/login.html
   ```

3. No arquivo `package.json`, crie um novo script para executar o deploy passando o YAML de configura√ß√£o:

   ```bash title="package.json"
   "scripts": {
     "deploy:auth0": "a0deploy import --input_file ./tenant.yaml"
   }
   ```

Bom, provavelmente, se voc√™ tentar rodar o deploy receber√° um erro 403 ou algo do tipo. O motivo: ainda n√£o foi configurado nenhuma credencial da Auth0 .

Por seguran√ßa, podemos adicionar essas credenciais direto no Azure DevOps. Dentro do seu projeto na Azure DevOps, v√° em Pipelines > Library e ent√£o crie um novo grupo com as vari√°veis: `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID` e `AUTH0_CLIENT_SECRET`.

No YAML da pipeline, vamos importar o grupo de vari√°veis que acabamos de criar. Ap√≥s, adicionar uma tarefa para rodar o script de deploy do `package.json` passando as ENVs.

```yaml title="azure-pipelines.yml"
variables:
  - group: auth0-credentials

steps:
  ...

  - script: |
      yarn deploy:auth0
    displayName: 'Auth0 deploy login HTML'
    env:
      AUTH0_DOMAIN: $(AUTH0_DOMAIN)
      AUTH0_CLIENT_ID: $(AUTH0_CLIENT_ID)
      AUTH0_CLIENT_SECRET: $(AUTH0_CLIENT_SECRET)
```

## Upload de est√°ticos na Amazon S3

### Requisitos

Antes de adicionar essa tarefa na pipelines, voc√™ vai precisar:

1. Instalar a extens√£o "AWS Toolkit for Azure DevOps"
2. Conectar sua conta AWS no projeto do Azure DevOps

[Em qualquer d√∫vida, voc√™ pode consultar a documenta√ß√£o da AWS.](https://docs.aws.amazon.com/vsts/latest/userguide/getting-started.html)

### Tarefa na pipeline

Vamos subir em um bucket no S3 todos arquivos, exceto os HTML. Para isso podemos pegar a pasta `_next` e todos os arquivos dentro. A tarefa no Azure Pipeline deve ficar:

```yaml title="azure-pipelines.yml"
- task: S3Upload@1
  inputs:
    awsCredentials: 'YOUR_AWS_CONNECTION'
    regionName: 'us-east-1'
    bucketName: 'auth0-custom-login-bucket'
    sourceFolder: '$(Build.SourcesDirectory)/out'
    globExpressions: '_next/**'
```

- **awsCredentials:** o nome da conex√£o feita com a AWS;
- **bucketName:** nome do seu bucket;
- **sourceFolder:** o caminho onde estar√° os arquivos para fazer upload;
- **globExpressions:** filtrar os arquivos para o upload.

## Conclus√£o

Gosto de seguir a filosofia ‚Äúgastar um pouco de tempo agora (presente) para ganhar (ou poupar) mais tempo no futuro‚Äù. Fazer um processo como esse de forma manual ~~al√©m de chato~~ se tornaria MUITO oneroso. A automa√ß√£o nos ajuda justamente nisso.

[O c√≥digo completo est√° hospedado no meu Github üòÉ.](https://github.com/mauriciomutte/auth0-custom-login-deploy)
